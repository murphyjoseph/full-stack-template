# CLAUDE.md — Package Guide (Delta) for api-schema

- **Status:** SUPPORTED
- **NAME:** `@repo/api-schema`
- **Path:** `packages/api-schema`
- **Root Guide:** See [`../../CLAUDE.md`](../../CLAUDE.md) — this file only adds package-specific deltas.

---

## 1) Purpose & Scope (Package-Specific)

- **What it is:** Framework-agnostic, typed API client and OpenAPI contract for the NestJS backend
- **Used for:**
  - Type-safe API calls from any JavaScript environment (browser, server, edge)
  - Storing the committed OpenAPI spec (`openapi.json`) — the API contract
  - Generating TypeScript types from the spec (`schema.d.ts`)
  - Providing a typed `openapi-fetch` client factory
- **Out of scope:**
  - React-specific code (React Query hooks live in `apps/web/external/openapi/`)
  - Runtime validation or DTOs (those live in `apps/server/`)
  - API middleware, auth, or error handling (consumers add their own)

---

## 2) Public API & Entry Points (Concrete)

- **Entry file:** `src/client.ts` (single module)

- **Primary exports (stable):**
  - `createApiClient(baseUrl: string)` — Factory returning a typed `openapi-fetch` client instance
  - `paths` type — Re-exported from `schema.d.ts`; all API endpoint types

- **Generated files (do not edit manually):**
  - `openapi.json` — Committed OpenAPI 3.0 spec, generated by `apps/server/scripts/generate-openapi.ts`
  - `src/schema.d.ts` — Generated by `openapi-typescript` from `openapi.json`; contains `paths`, `components`, `operations` interfaces

- **Notes on stability/behavior:**
  - `openapi.json` is the API contract — committed to git, reviewed in PRs
  - `schema.d.ts` is generated and committed — do not hand-edit
  - The client is a thin wrapper around `openapi-fetch` — no custom logic

---

## 3) File Placement & Scaffolding (Deltas Only)

- **Place code under:** `packages/api-schema/src/`
- **Tests:** `vitest.config.ts` present (uses `@repo/config-vitest/react`)
- **Forbidden:**
  - Do **not** add React or framework-specific code
  - Do **not** hand-edit `openapi.json` or `schema.d.ts`
  - Do **not** reference environment variables (per `packages/CLAUDE.md`)
- **Cross-package imports:**
  - **MAY** be imported by any app in the monorepo
  - **MUST NOT** import from other workspace packages (stays framework-agnostic)

---

## 4) Usage Rules (Do / Don't) — Package-Specific

- **MUST** regenerate types after changing NestJS endpoints or DTOs (`pnpm generate:types`)
- **MUST** commit both `openapi.json` and `schema.d.ts` together
- **MUST** keep the package framework-agnostic (no React, no Node.js-only APIs)
- **SHOULD** review `openapi.json` diffs in PRs (they represent API contract changes)
- **MUST NOT** hand-edit generated files (`openapi.json`, `schema.d.ts`)
- **MUST NOT** add React Query, React hooks, or framework bindings here
- **MUST NOT** add middleware, auth, or error handling (consumers do this)

---

## 5) Dependencies & Integration (Deltas Only)

- **Allowed deps:**
  - `openapi-fetch` — typed fetch client (current sole runtime dependency)
- **Forbidden deps:**
  - React or any UI framework
  - `openapi-react-query` (belongs in `apps/web/external/`)
  - HTTP clients (axios, etc.)
  - Validation libraries
- **Dev deps:** `openapi-typescript` (generates `schema.d.ts`)
- **Peer deps:** None
- **Env assumption:** Universal (browser + Node.js + edge)
- **Current consumers:**
  - `apps/web/external/openapi/client.browser.ts` — wraps with React Query + middlewares
  - `apps/web/external/openapi/client.server.ts` — wraps with server-side middlewares

---

## 6) Build, Test, and Lint (Deltas Only)

- **Generate types:** `pnpm --filter @repo/api-schema generate` (runs `openapi-typescript`)
- **Full pipeline:** `pnpm generate:types` (generates OpenAPI spec from server, then TypeScript types)
- **Test:** `pnpm --filter @repo/api-schema test`
- **Typecheck:** `pnpm --filter @repo/api-schema check-types`
- **Lint:** `pnpm --filter @repo/api-schema lint`
- **CI rule:** All above must pass; `openapi.json` and `schema.d.ts` must be in sync

---

## 7) Security, Performance, Accessibility (Deltas Only)

- **Security:**
  - No auth logic in this package (consumers handle auth via middlewares)
  - No secret storage or environment variable access
- **Performance:**
  - Thin wrapper over `openapi-fetch` — minimal overhead
  - Tree-shakeable (import only what you use)
- **A11y:** Not applicable (API client only)

---

## 8) Examples (≤25 lines total)

### Direct Fetch Client

```ts
import { createApiClient } from "@repo/api-schema";

const api = createApiClient("http://localhost:3001");
const { data, error } = await api.GET("/contacts");
// data: ContactDto[] | undefined, error: typed error | undefined
```

### With React Query (in apps/web)

```ts
import { $apiBrowser } from "@/api";

const { data } = $apiBrowser.useQuery("get", "/contacts");
const mutation = $apiBrowser.useMutation("post", "/contacts");
await mutation.mutateAsync({ body: { name: "Jane", email: "j@x.com", message: "Hi" } });
```

---

## 9) Questions to Ask (Before Changes)

- Is this a **contract change** (new endpoint, changed DTO)? If so, change the NestJS DTOs first, then regenerate.
- Are you editing `openapi.json` or `schema.d.ts` by hand? **Don't.** Regenerate instead.
- Does this add **React or framework code**? If so, it belongs in `apps/web/external/`, not here.
- Does this add a **new runtime dependency**? Justify why `openapi-fetch` isn't sufficient.

> If any are unclear, **STOP and ASK for clarification**.

---

## 10) PR Checklist (Scoped)

- [ ] `openapi.json` and `schema.d.ts` are regenerated and committed together
- [ ] No hand-edits to generated files
- [ ] No React or framework-specific code
- [ ] No environment variable references
- [ ] Package remains framework-agnostic (browser + Node.js + edge)
- [ ] Changes limited to `packages/api-schema/`

---

## 11) Quick Enforcement Checks

```bash
# Framework imports (should be empty)
rg -n "from ['\"]react|from ['\"]next|from ['\"]@nestjs" packages/api-schema/src || echo "OK: No framework imports"

# Environment variable usage (should be empty)
rg -n "process\.env" packages/api-schema/src || echo "OK: No env vars"

# Runtime dependencies (should only be openapi-fetch)
jq -r '.dependencies // {} | keys[]' packages/api-schema/package.json

# Generated files in sync
pnpm --filter @repo/api-schema generate && git diff --exit-code packages/api-schema/src/schema.d.ts || echo "WARN: schema.d.ts out of sync"
```
