# CLAUDE.md — Package Guide (Delta) for ui

- **Status:** SUPPORTED
- **NAME:** `@repo/ui`
- **Path:** `packages/ui`
- **Root Guide:** See [`../../CLAUDE.md`](../../CLAUDE.md) — this file only adds package-specific deltas.

---

## 1) Purpose & Scope (Package-Specific)

- **What it is:** Unified React component library built on Park UI (Ark UI) + Panda CSS, providing the monorepo's design system
- **Used for:**
  - Pre-styled, accessible React components (62 total)
  - Design system tokens, recipes, and patterns via a shared preset
  - Layout primitives (`Container`, `Stack`, `Flex`, `Box`) via Panda CSS JSX
  - CSS utilities (`css()`, `styled()`) for one-off styles
- **Out of scope:**
  - App-specific components or page layouts (those live in `apps/web/`)
  - Business logic or data fetching
  - API client or state management
  - Non-React frameworks

---

## 2) Public API & Entry Points (Concrete)

- **62 component exports** — each via its own entry in `package.json`:
  - `@repo/ui/button`, `@repo/ui/card`, `@repo/ui/dialog`, `@repo/ui/field`, `@repo/ui/alert`, etc.
  - Full list in `package.json` lines 31-92

- **Utility exports:**
  - `@repo/ui/css` → `styled-system/css` (Panda CSS `css()` function)
  - `@repo/ui/jsx` → `styled-system/jsx` (layout components + `styled()` factory + `createStyleContext`)
  - `@repo/ui/recipes` → `styled-system/recipes`
  - `@repo/ui/tokens` → `styled-system/tokens`
  - `@repo/ui/patterns` → `styled-system/patterns`
  - `@repo/ui/types` → `styled-system/types`
  - `@repo/ui/preset` → `preset/index.ts` (shared design system config)
  - `@repo/ui/panda-config` → `panda-config.ts` (createAppConfig helper for consuming apps)
  - `@repo/ui/postcss-config` → `postcss-config.mjs` (PostCSS config for Panda CSS)

- **Internal (do not import externally):**
  - `lib/create-style-context.tsx` — injected into `styled-system/jsx/` by codegen hook
  - `styled-system/` — generated by `panda codegen`, not committed

---

## 3) File Placement & Scaffolding (Deltas Only)

- **Components:** `packages/ui/src/components/<name>.tsx` — one file per component
- **Recipes:** `packages/ui/recipes/<name>.ts` — custom slot/base recipes, registered in `preset/index.ts`
- **Preset:** `packages/ui/preset/index.ts` — single design system config (tokens, recipes, colors)
- **Style context:** `packages/ui/lib/create-style-context.tsx` — Park UI pattern factory
- **Generated:** `packages/ui/styled-system/` — output of `panda codegen` (gitignored)

- **Component patterns (three types):**
  1. **Simple styled:** `export const Text = styled('p', text)` — wraps HTML element with recipe
  2. **Multi-slot:** Uses `createStyleContext(recipe)` → `withProvider`/`withContext` for compound components (Card.Root, Card.Header, etc.)
  3. **Enhanced:** Wraps Ark UI primitives with custom logic (loading states, icons)

- **Forbidden:**
  - Do **not** create barrel files (`index.ts` re-exports)
  - Do **not** add a tsup/tsc build step for components (causes TS7056/ConditionalValue type conflicts)
  - Do **not** hand-edit files in `styled-system/` (generated by codegen)
  - Do **not** add app-specific or business logic

- **Cross-package imports:**
  - **MAY** be imported by any app (currently `apps/web/`)
  - **MUST NOT** import from other workspace packages (except Panda CSS + Ark UI deps)

---

## 4) Usage Rules (Do / Don't) — Package-Specific

- **MUST** use per-component imports (`@repo/ui/button`, not `@repo/ui`)
- **MUST** use `styled()` factory with `withProvider`/`withContext` from `createStyleContext` for multi-slot components
- **MUST** return `any` types from `withProvider`/`withContext` wrappers (avoids ConditionalValue type conflicts)
- **MUST** use `withRootProvider` for components that don't render DOM (Dialog.Root, Menu.Root)
- **MUST** register new recipes in `preset/index.ts`
- **MUST** add new component exports to `package.json` exports map
- **SHOULD** prefer Park UI components over raw `css()` calls
- **SHOULD** use semantic components (`Heading`, `Text`, `Button`) over generic styled divs
- **MUST NOT** create barrel files
- **MUST NOT** add tsup/tsc build step for component `.tsx` files
- **MUST NOT** use `import.meta.url` in `panda.config.ts` (Panda bundles config to CJS — use `process.cwd()`)

---

## 5) Dependencies & Integration (Deltas Only)

- **Runtime deps:**
  - `@ark-ui/react` — Unstyled, accessible component primitives
  - `lucide-react` — Icon library
  - `react`, `react-dom` — React 19
- **Dev deps:**
  - `@pandacss/dev` — CSS generation (build-time only)
  - `@park-ui/panda-preset` — Design system preset base
  - `@repo/config-eslint`, `@repo/config-typescript`
- **Forbidden deps:**
  - Data fetching libraries (openapi-fetch, TanStack Query)
  - State management libraries
  - Server-only APIs
- **Current consumers:**
  - `apps/web/` — imports components and preset
  - `apps/web/panda.config.ts` — imports `uiPreset` for shared design tokens

---

## 6) Build, Test, and Lint (Deltas Only)

- **Build:** `pnpm --filter @repo/ui build` — runs `panda codegen`, generates `styled-system/`
- **Dev:** `pnpm --filter @repo/ui dev` — runs `panda codegen --watch`
- **Lint:** `pnpm --filter @repo/ui lint`
- **Typecheck:** `pnpm --filter @repo/ui check-types`
- **No test runner** — components are tested via app-level E2E tests (Playwright)
- **CI rule:** Build and typecheck must pass

### Codegen Hook

The `codegen:done` hook in `panda.config.ts` runs after every `panda codegen` (including `--watch`):
1. Copies `lib/create-style-context.tsx` → `styled-system/jsx/create-style-context.tsx`
2. Appends `export { createStyleContext }` to `styled-system/jsx/index.mjs` and `.d.ts` (idempotent)

---

## 7) Security, Performance, Accessibility (Deltas Only)

- **Security:** No user input handling, no API calls
- **Performance:**
  - Per-component exports enable tree-shaking
  - Source-compiled by Next.js — no double-bundling
  - CSS extracted at build time by Panda CSS (no runtime CSS-in-JS)
- **A11y:**
  - Ark UI primitives provide WAI-ARIA compliant behavior
  - Components inherit keyboard navigation, focus management, screen reader support from Ark UI

---

## 8) Examples (≤25 lines total)

### Using Components

```tsx
import { Button } from "@repo/ui/button";
import { Heading } from "@repo/ui/heading";
import { Container, Stack } from "@repo/ui/jsx";
import * as Card from "@repo/ui/card";

<Container>
  <Stack gap="4">
    <Heading as="h1">Title</Heading>
    <Card.Root>
      <Card.Header><Card.Title>Card</Card.Title></Card.Header>
      <Card.Body>Content</Card.Body>
    </Card.Root>
    <Button variant="outline">Click me</Button>
  </Stack>
</Container>
```

### Adding a New Component

```tsx
// src/components/my-component.tsx
import { ark } from "@ark-ui/react";
import { styled } from "@repo/ui/jsx";
import { myComponent } from "@repo/ui/recipes";

export const MyComponent = styled(ark.div, myComponent);
```

---

## 9) Questions to Ask (Before Changes)

- Does this component already exist in **Park UI**? (Check Ark UI docs first.)
- Is this **app-specific** or **reusable**? (App-specific goes in `apps/web/`.)
- Does the recipe need **slots**? (If yes, use `createStyleContext`. If no, use `styled()`.)
- Did you add the **export to `package.json`**?
- Did you register the **recipe in `preset/index.ts`**?

> If any are unclear, **STOP and ASK for clarification**.

---

## 10) PR Checklist (Scoped)

- [ ] Component uses per-component export in `package.json`
- [ ] No barrel files created
- [ ] Multi-slot components use `createStyleContext` with `any` return types
- [ ] New recipes registered in `preset/index.ts`
- [ ] No tsup/tsc build step for `.tsx` files
- [ ] `panda codegen` succeeds without errors
- [ ] Typecheck passes (`pnpm --filter @repo/ui check-types`)
- [ ] Changes limited to `packages/ui/`

---

## 11) Quick Enforcement Checks

```bash
# No barrel files (should be empty)
rg -n "export \* from" packages/ui/src/ || echo "OK: No barrel exports"

# No build step for components (should not have tsup in package.json scripts)
jq '.scripts.build' packages/ui/package.json
# Expected: "panda codegen"

# Verify codegen hook exists
rg "codegen:done" packages/ui/panda.config.ts

# All component exports present in package.json
ls packages/ui/src/components/*.tsx | wc -l
jq '.exports | keys | length' packages/ui/package.json
```
